# Database Fixtures - BookingService

Тестовые данные для локальной разработки и тестирования BookingService.

## Загрузка фикстур

```bash
# Применить миграции и загрузить фикстуры
make db-reset
make fixtures

# Или вручную через psql
docker exec -i bookingservice-db psql -U postgres -d smc_bookingservice < migrations/fixtures/001_company_configs.sql
docker exec -i bookingservice-db psql -U postgres -d smc_bookingservice < migrations/fixtures/002_bookings.sql
```

## Содержимое фикстур

### 001_company_configs.sql - Конфигурация слотов

**7 конфигураций** для демонстрации иерархической системы:

#### Компания 1: Автомойка Премиум
- **Адреса**: 100 (Тверская), 101 (Ленина)
- **Услуги**: 1 (Комплексная мойка), 2 (Экспресс-мойка), 3 (Детейлинг)

| Приоритет | CompanyID | AddressID | ServiceID | Боксов | Слот (мин) | AdvanceDays | MinNotice (мин) |
|-----------|-----------|-----------|-----------|--------|------------|-------------|-----------------|
| 5 (низший)| 1         | NULL      | NULL      | 3      | 30         | 30          | 60              |
| 3         | 1         | 100       | NULL      | 4      | 30         | 30          | 60              |
| 3         | 1         | 101       | NULL      | 2      | 30         | 0           | 60              |
| 1 (высший)| 1         | 100       | 2         | 4      | 30         | 30          | 30              |
| 1 (высший)| 1         | 101       | 3         | 1      | 60         | 0           | 120             |

**Примеры разрешения конфигурации:**
- Услуга 1 на адресе 100 → (1, 100, NULL) = 4 бокса
- Услуга 2 на адресе 100 → (1, 100, 2) = 4 бокса, 30 мин уведомления
- Услуга 3 на адресе 101 → (1, 101, 3) = 1 бокс, 120 мин уведомления
- Услуга 1 на адресе 101 → (1, 101, NULL) = 2 бокса

#### Компания 2: СТО Профи
- **Адрес**: 200 (Новая)
- **Услуга**: 10 (Замена масла)

| CompanyID | AddressID | ServiceID | Боксов | Слот (мин) | AdvanceDays | MinNotice (мин) |
|-----------|-----------|-----------|--------|------------|-------------|-----------------|
| 2         | NULL      | NULL      | 1      | 45         | 0           | 120             |

**Особенность:** Круглосуточная работа, 1 бокс, бронирование минимум за 2 часа.

#### Компания 3: Детейлинг Центр
- **Адрес**: 300 (Невский пр.)
- **Услуга**: 20 (Полировка кузова)

| CompanyID | AddressID | ServiceID | Боксов | Слот (мин) | AdvanceDays | MinNotice (мин) |
|-----------|-----------|-----------|--------|------------|-------------|-----------------|
| 3         | NULL      | NULL      | 6      | 60         | 14          | 30              |

**Особенность:** Большая мощность (6 боксов), но бронировать можно только на 14 дней вперёд.

---

### 002_bookings.sql - Тестовые бронирования

**15 бронирований** с разными статусами и сценариями:

#### Компания 1, Адрес 100 (Тверская)

| ID | UserID     | ServiceID | Дата            | Время | Статус    | Примечание                          |
|----|------------|-----------|-----------------|-------|-----------|-------------------------------------|
| 1  | 123456789  | 1         | Завтра          | 10:00 | confirmed | С notes "внимание дискам"           |
| 2  | 987654321  | 1         | Завтра          | 10:00 | confirmed | **Параллельное бронирование** (2/4) |
| 3  | 111222333  | 2         | Завтра          | 14:00 | confirmed | Экспресс-мойка                      |
| 4  | 123456789  | 2         | 7 дней назад    | 11:00 | completed | История пользователя                |
| 5  | 444555666  | 1         | Завтра          | 16:00 | confirmed | **Занято 3/4 боксов**               |
| 6  | 555666777  | 1         | Завтра          | 16:00 | confirmed | **Занято 4/4 боксов** (полный слот) |

#### Компания 1, Адрес 101 (Ленина)

| ID | UserID     | ServiceID | Дата            | Время | Статус                | Примечание                  |
|----|------------|-----------|-----------------|-------|-----------------------|-----------------------------|
| 7  | 123456789  | 3         | Через 2 дня     | 10:00 | confirmed             | Детейлинг с notes           |
| 8  | 666777888  | 3         | Через 3 дня     | 15:00 | cancelled_by_company  | Технические работы          |

#### Компания 2, Адрес 200 (СТО Профи)

| ID | UserID     | ServiceID | Дата            | Время | Статус             | Примечание                  |
|----|------------|-----------|-----------------|-------|--------------------|-----------------------------|
| 9  | 987654321  | 10        | 2 дня назад     | 16:00 | cancelled_by_user  | "Изменились планы"          |
| 10 | 555666777  | 10        | Вчера           | 09:00 | no_show            | Клиент не явился            |
| 11 | 444555666  | 10        | Сегодня         | 12:00 | in_progress        | **Текущее** бронирование    |

#### Компания 3, Адрес 300 (Детейлинг Центр)

| ID | UserID     | ServiceID | Дата            | Время | Статус    | Примечание                  |
|----|------------|-----------|-----------------|-------|-----------|-----------------------------|
| 12 | 777888999  | 20        | Через 5 дней    | 10:00 | pending   | Ожидает подтверждения       |
| 13 | 123456789  | 20        | Через 10 дней   | 14:00 | confirmed | Полировка                   |

#### Дополнительная история для пользователя 123456789

| ID | UserID     | Компания | Адрес | Дата            | Статус    | Примечание                  |
|----|------------|----------|-------|-----------------|-----------|------------------------------|
| 14 | 123456789  | 1        | 100   | 14 дней назад   | completed | Старая история              |
| 15 | 123456789  | 2        | 200   | 30 дней назад   | completed | Очень старая история        |

---

## Сводная статистика

### По статусам
- **confirmed**: 7 бронирований
- **completed**: 3 бронирования
- **cancelled_by_user**: 1 бронирование
- **cancelled_by_company**: 1 бронирование
- **no_show**: 1 бронирование
- **in_progress**: 1 бронирование
- **pending**: 1 бронирование

### По компаниям
- **Компания 1**: 8 бронирований (6 на адресе 100, 2 на адресе 101)
- **Компания 2**: 4 бронирования (3 на адресе 200, 1 в истории)
- **Компания 3**: 2 бронирования (оба на адресе 300)

### По пользователям
- **123456789**: 6 бронирований (1 на завтра, 1 через 2 дня, 1 через 10 дней, 3 в истории)
- **987654321**: 2 бронирования
- **111222333**: 1 бронирование
- **444555666**: 2 бронирования
- **555666777**: 2 бронирования
- **666777888**: 1 бронирование
- **777888999**: 1 бронирование

---

## Тестовые сценарии

### 1. Параллельные бронирования
- Завтра в 10:00 на адресе 100: **2/4 боксов занято**
- Можно создать ещё 2 бронирования в этот слот

### 2. Полностью занятый слот
- Завтра в 16:00 на адресе 100: **4/4 боксов занято**
- Попытка создать новое бронирование должна вернуть `409 Conflict`

### 3. Разные адреса одной компании
- Компания 1 имеет 2 адреса: 100 и 101
- Бронирования на адресе 100 не влияют на адрес 101

### 4. История пользователя
- Пользователь 123456789 имеет богатую историю:
  - 3 выполненных бронирования в прошлом
  - 3 активных/будущих бронирования

### 5. Разные статусы
- Есть бронирования со всеми возможными статусами
- Можно тестировать фильтрацию по статусам

---

## Совместимость с другими сервисами

### Требуются данные в UserService:

```json
// Пользователь 123456789
{
  "tgUserId": 123456789,
  "selectedCar": {
    "id": 1001,
    "brand": "BMW",
    "model": "X5",
    "licensePlate": "А123БВ799"
  }
}

// Пользователь 987654321
{
  "tgUserId": 987654321,
  "selectedCar": {
    "id": 2001,
    "brand": "Mercedes",
    "model": "E-Class",
    "licensePlate": "В999КС777"
  }
}

// И так далее для остальных пользователей...
```

### Требуются данные в SellerService:

```json
// Компания 1
{
  "id": 1,
  "name": "Автомойка Премиум",
  "addresses": [
    {
      "id": 100,
      "city": "Москва",
      "street": "ул. Тверская",
      "building": "10"
    },
    {
      "id": 101,
      "city": "Москва",
      "street": "ул. Ленина",
      "building": "5"
    }
  ],
  "workingHours": {
    "monday": {"isOpen": true, "openTime": "09:00", "closeTime": "21:00"},
    "sunday": {"isOpen": false}
  },
  "managerIds": [777777777]
}

// Услуги компании 1
{
  "id": 1,
  "companyId": 1,
  "name": "Комплексная мойка",
  "price": 1500.00,
  "averageDuration": 60,
  "addressIds": [100, 101]
}
{
  "id": 2,
  "companyId": 1,
  "name": "Экспресс-мойка",
  "price": 800.00,
  "averageDuration": 30,
  "addressIds": [100]
}
{
  "id": 3,
  "companyId": 1,
  "name": "Детейлинг",
  "price": 5000.00,
  "averageDuration": 120,
  "addressIds": [101]
}

// Компания 2, Компания 3 аналогично...
```

---

## Проверка загруженных данных

```bash
# Подключиться к БД
docker exec -it bookingservice-db psql -U postgres -d smc_bookingservice

# Проверить конфигурации
SELECT company_id, address_id, service_id, max_concurrent_bookings, advance_booking_days
FROM company_slots_config
ORDER BY company_id, address_id NULLS FIRST, service_id NULLS FIRST;

# Проверить бронирования
SELECT id, user_id, company_id, address_id, service_id, booking_date, status
FROM bookings
ORDER BY booking_date DESC, start_time;

# Проверить количество бронирований по статусам
SELECT status, COUNT(*)
FROM bookings
GROUP BY status;

# Проверить параллельные бронирования
SELECT booking_date, start_time, COUNT(*) as concurrent_count
FROM bookings
WHERE status NOT IN ('cancelled_by_user', 'cancelled_by_company', 'no_show')
  AND company_id = 1 AND address_id = 100
GROUP BY booking_date, start_time
HAVING COUNT(*) > 1;
```

---

## Сброс данных

```bash
# Полный сброс базы данных и повторная загрузка фикстур
make db-reset
make fixtures
```

---

## Обновление фикстур

Если вы изменили фикстуры, используйте команду:

```bash
# Фикстуры используют ON CONFLICT DO UPDATE
# Поэтому можно просто применить их заново
make fixtures
```

**Важно:** Фикстуры используют `ON CONFLICT DO UPDATE`, поэтому их можно применять повторно без ошибок дубликатов.
